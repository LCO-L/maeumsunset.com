<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>캠프파이어 저널 — 초경량</title>
<style>
  :root{--bg:#0b0f14;--card:#11171f;--ink:#eaeef3;--ring:#2b3442;--accent:#ffc27a}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:#0b0f14;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
  .wrap{max-width:920px;margin:20px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;margin-bottom:12px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .btn{appearance:none;border:1px solid var(--ring);background:#151c25;color:var(--ink);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
  @media(min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
  .camp{position:relative;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;background:linear-gradient(180deg,rgba(18,23,30,.7),rgba(12,16,22,.8))}
  .campHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .campStats{color:var(--accent);font-weight:800}
  .campArt{height:180px;border-radius:12px;background:#0b0f14;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
  .campArt svg{width:100%;height:100%}
  .hidden{display:none}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111821;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;transition:.2s}
  .toast.show{opacity:1}
  textarea{width:100%;min-height:110px;background:#0c1117;color:var(--ink);border:1px solid var(--ring);border-radius:12px;padding:12px}
</style>
<body>
  <div class="wrap">
    <div class="card"><div class="row"><strong>🔥 캠프파이어</strong><span id="today"></span></div></div>
    <div class="card">
      <div class="row"><h3 style="margin:0">오늘의 캠프</h3><button id="editBtn" class="btn">주제 편집</button></div>
      <div id="grid" class="grid"></div>
    </div>

    <div id="room" class="card hidden">
      <div class="row">
        <h3 id="roomTitle" style="margin:0"></h3>
        <div style="display:flex;gap:8px">
          <button id="backBtn" class="btn">목록으로</button>
          <button id="renameBtn" class="btn">주제 바꾸기</button>
        </div>
      </div>
      <div class="card">
        <textarea id="journal" placeholder="여기에 오늘의 노트를 적어주세요."></textarea>
        <div class="row"><div id="len" style="opacity:.8">0자</div><button id="saveBtn" class="btn">저장</button></div>
      </div>
      <div id="posts"></div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

<script>
  // 초경량 셸: SVG만 그리고, 클릭 시 app.js를 동적 로드하여 기능 활성화
  const $=s=>document.querySelector(s);
  const today = new Date().toISOString().slice(0,10);
  $('#today').textContent = today;

  function getTopics(){
    try{ const v = localStorage.getItem('camp_topics:'+today); if(v) return JSON.parse(v);}catch(e){}
    const t=[{id:0,title:"오늘의 하이라이트"},{id:1,title:"지금 내 감정"},{id:2,title:"내가 선택할 작은 행동"}];
    try{ localStorage.setItem('camp_topics:'+today, JSON.stringify(t)); }catch(e){}
    return t;
  }
  let TOPICS = getTopics();

  const FIRE_SVG = (seed=0)=>`<svg viewBox="0 0 320 180" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="캠프파이어">
    <defs>
      <radialGradient id="g${seed}" cx="50%" cy="70%" r="60%">
        <stop offset="0%" stop-color="rgba(255,240,220,0.95)"/>
        <stop offset="35%" stop-color="rgba(255,165,80,0.8)"/>
        <stop offset="70%" stop-color="rgba(255,110,40,0.4)"/>
        <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
      </radialGradient>
    </defs>
    <rect width="100%" height="100%" fill="#0b0f14"/>
    <ellipse cx="160" cy="150" rx="120" ry="18" fill="rgba(255,180,100,0.18)"/>
    <ellipse cx="160" cy="110" rx="60" ry="70" fill="url(#g${seed})"/>
    <g opacity=".9" transform="translate(0,8)">
      <rect x="90" y="132" width="140" height="10" rx="5" fill="#6b4e3a"/>
      <rect x="90" y="132" width="140" height="10" rx="5" fill="#8c6348" transform="rotate(-12 160 137)"/>
    </g>
    <ellipse cx="160" cy="150" rx="140" ry="24" fill="#444a52"/>
  </svg>`;

  function renderGrid(){
    const grid = $('#grid'); grid.innerHTML='';
    for(let i=0;i<3;i++){
      const div=document.createElement('div'); div.className='camp';
      const topic = TOPICS[i]?.title || ('캠프 '+(i+1));
      div.innerHTML = \`
        <div class="campHead">
          <div style="font-weight:800">\${topic}</div>
          <div class="campStats" id="stat\${i}">불러오는 중…</div>
        </div>
        <div class="campArt">\${FIRE_SVG(i)}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-open="\${i}">열기</button>
        </div>\`;
      grid.appendChild(div);
    }
  }

  function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

  renderGrid();
  // 동적 로드: 첫 상호작용 시 app.js import → 무거운 로직은 뒤로
  let appLoaded=false, app=null;
  async function ensureApp(){
    if(appLoaded) return app;
    appLoaded=true;
    app = await import('./app.js'); // 모듈 로드
    // 통계 표시 업데이트
    for(let i=0;i<3;i++){
      const roomId = app.getRoomId(i);
      const data = app.loadRoom(roomId);
      const likes = (data.answers||[]).reduce((a,b)=>a+(b.likes||0),0);
      document.getElementById('stat'+i).textContent = '❤️ '+likes+' · 노트 '+(data.answers?.length||0);
    }
    return app;
  }

  // 이벤트 위임
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    if(btn.id==='editBtn'){
      const cur = TOPICS.map(t=>t.title).join('\n');
      const next = prompt('세 줄로 주제를 입력하세요', cur);
      if(!next) return;
      const parts = next.split(/\r?\n/).filter(Boolean).slice(0,3);
      while(parts.length<3) parts.push('캠프 '+(parts.length+1));
      TOPICS = parts.map((t,i)=>({id:i,title:t.trim()}));
      localStorage.setItem('camp_topics:'+today, JSON.stringify(TOPICS));
      renderGrid(); // 제목 즉시 반영
      // 통계는 app.js 로드 후 갱신
      try{ await ensureApp(); }catch{}
      return;
    }
    if(btn.dataset.open){
      const idx = +btn.dataset.open;
      const mod = await ensureApp();
      mod.openCamp(idx); // app.js가 방 화면 렌더링
      return;
    }
  });
</script>
</body>
</html>
